user root;
worker_processes 8;
worker_rlimit_nofile 65535;
events {
	use  epoll;
	worker_connections 65535;
}

http {
    client_body_timeout 300;
    client_header_timeout 300;
    send_timeout 300;
    keepalive_timeout 300;
    server_tokens off;

    limit_conn_zone $binary_remote_addr zone=test:100m;
    limit_conn_status 503;
    limit_conn_log_level error;

    map $time_iso8601 $logdate {
        '~^(?<ymd>\d{4}-\d{2}-\d{2})' $ymd;
        default  'date-not-found';
        }
    log_format main  '$remote_addr $upstream_addr $request_time $upstream_response_time - [$time_local] $request_method "$uri" "$query_string" '
                     '$status $body_bytes_sent "$http_referer" '
                     '"$http_user_agent" "$http_x_forwarded_for"';
 
   access_log  logs/oneops-access-$logdate.log  main;
   error_log   logs/oneops-error.log;


    # 定义一个变量用于提取 host 参数
    map $arg_host $backend_host {
        default "";
        "~^(.+)$" "$1";
    }


    server {
        listen 30000 ssl;
        ssl_certificate     /web/soft/nginx/conf/ssl/server.crt;  
        ssl_certificate_key /web/soft/nginx/conf/ssl/server.key;  
        ssl_protocols       TLSv1.2 TLSv1.3;
        ssl_prefer_server_ciphers on;
   
        error_page 400 404 413 502 504 /404.html;
        location = /404.html {
          internal;
        }
        location /oneagent {
            # 检查是否提供了 host 参数
            if ($arg_host = "") {
                return 400 "Missing 'host' parameter in the request.";
            }

            # 动态设置后端目标地址
            set $target https://$backend_host/OneAgentMetrics;

            # 设置代理头信息
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 转发到内网主机的 9150 端口
            proxy_pass $target;

            # SSL 相关配置（可选）
            proxy_ssl_verify off; # 如果信任内网主机证书，可以关闭验证
            proxy_ssl_server_name on; # 支持 SNI

            # 超时设置
            proxy_connect_timeout 10s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }



     location /icmp {
            # 参数检查
            if ($arg_host = "") {
                return 400 "Missing 'host' parameter in the request.";
            }
            if ($arg_icmpType = "") {
                return 400 "Missing 'icmpType' parameter in the request.";
            }
            if ($arg_target = "") {
                return 400 "Missing 'target' parameter in the request.";
            }

            # 动态转发
            #set $backend "$arg_host:9150";
            set $backend "$arg_host";

            proxy_pass https://$backend/icmpMetrics?icmpType=$arg_icmpType&target=$arg_target;

            # 忽略 SSL 校验（自签证书情况下）
            proxy_ssl_verify off;
            proxy_ssl_server_name on;

            # 请求头信息
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 超时设置
            proxy_connect_timeout 10s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
     } 


     location /sqlexporter {
            # 参数检查
            if ($arg_exporter = "") {
                return 400 "Missing 'host' parameter in the request.";
            }
            if ($arg_target = "") {
                return 400 "Missing 'target' parameter in the request.";
            }

            # 动态转发
            set $backend "$arg_exporter";

            proxy_pass https://$backend/sqlexporter/service/sqlExporterService/getMetrics/0?target=$arg_target;

            # 忽略 SSL 校验（自签证书情况下）
            proxy_ssl_verify off;
            proxy_ssl_server_name on;

            # 请求头信息
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # 超时设置
            proxy_connect_timeout 10s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
     }



 }

      vhost_traffic_status_zone; 
      vhost_traffic_status_filter_by_host on; 
      server {
        listen 9999;
        server_name localhost;
        location /status {
            vhost_traffic_status_display;
            vhost_traffic_status_display_format html;
        }
        location /check {
            #check_status;
        }
        location /nginx_status {
            #stub_status on;
        } 
      }
}



